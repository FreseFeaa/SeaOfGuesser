{% extends "base.html" %}

{% block content %}
<h2>–£–≥–∞–¥–∞–π—Ç–µ –º–µ—Å—Ç–æ</h2>

<div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
    <!-- –ë–ª–æ–∫ —Å —Ä–∞–Ω–¥–æ–º–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π -->
    <div style="flex: 1; min-width: 300px; border: 2px solid #4CAF50; padding: 10px; text-align: center;">
        <h3>–ß—Ç–æ —ç—Ç–æ –∑–∞ –º–µ—Å—Ç–æ?</h3>
        {% if place and place.img %}
            <img src="{{ place.img }}" alt="–£–≥–∞–¥—ã–≤–∞–µ–º–æ–µ –º–µ—Å—Ç–æ" 
                 style="max-width: 100%; max-height: 300px;">
        {% else %}
            <p style="color: red;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>
        {% endif %}
    </div>

    <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ–π -->
   <div style="flex: 1; min-width: 300px; position: relative; border: 2px solid #4CAF50; padding: 10px;">
    <h3>–û—Ç–º–µ—Ç—å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
    <div id="map-container">
        <img id="map" src="{{ url_for('static', filename='images/map.jpg') }}" alt="–ö–∞—Ä—Ç–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏">
        
        <!-- –ú–∞—Ä–∫–µ—Ä—ã –∏ –ª–∏–Ω–∏—è -->
        <div id="user-marker" style="display: none; position: absolute; width: 16px; height: 16px; 
             background: red; border-radius: 50%; transform: translate(-50%, -50%); z-index: 2;"></div>
        <div id="correct-marker" style="display: none; position: absolute; width: 16px; height: 16px; 
             background: green; border-radius: 50%; transform: translate(-50%, -50%); z-index: 2;"></div>
        <svg id="line" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
             pointer-events: none; display: none; z-index: 1;"></svg>
    </div>
</div>
</div>

<!-- –§–æ—Ä–º–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<form id="guess-form" method="POST" action="{{ url_for('game') }}">
    <input type="hidden" name="place_id" value="{{ place.id if place else '' }}">
    <input type="hidden" id="lat-input" name="lat">
    <input type="hidden" id="lon-input" name="lon">
    
    <div id="result-panel" style="{% if not show_results %}display: none;{% endif %} 
         margin: 15px 0; padding: 15px; background: #f0f8ff; border-radius: 5px;">
        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
        <p>üìç –í–∞—à–∞ —Ç–æ—á–∫–∞: (<span id="user-coords">{{ "%.3f"|format(user_guess_x) if user_guess_x else '-' }}</span>, 
                         <span id="user-coords-y">{{ "%.3f"|format(user_guess_y) if user_guess_y else '-' }}</span>)</p>
        <p>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: (<span id="correct-coords-x">{{ "%.3f"|format(correct_x) if correct_x else '-' }}</span>, 
                        <span id="correct-coords-y">{{ "%.3f"|format(correct_y) if correct_y else '-' }}</span>)</p>
        <p>üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <span id="distance">{{ "%.3f"|format(distance) if distance else '-' }}</span></p>
        <p>‚≠ê –û—á–∫–∏: <span id="points-earned">{{ points_earned if points_earned else '0' }}</span></p>
        
        <button type="button" id="new-game-btn" 
                style="padding: 10px 25px; background-color: #4CAF50; color: white; 
                       border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px;">
            –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
    </div>

    <button type="submit" id="submit-btn" {% if show_results %}disabled style="display: none;"{% endif %}
            style="padding: 10px 25px; background-color: #4CAF50; color: white; 
                   border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
    </button>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = document.getElementById('map');
    const userMarker = document.getElementById('user-marker');
    const correctMarker = document.getElementById('correct-marker');
    const line = document.getElementById('line');
    const latInput = document.getElementById('lat-input');
    const lonInput = document.getElementById('lon-input');
    const submitBtn = document.getElementById('submit-btn');
    const resultPanel = document.getElementById('result-panel');
    const newGameBtn = document.getElementById('new-game-btn');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    function getMapDimensions() {
        const rect = map.getBoundingClientRect();
        const naturalWidth = map.naturalWidth;
        const naturalHeight = map.naturalHeight;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –∏ –æ—Ç—Å—Ç—É–ø—ã
        const containerRatio = rect.width / rect.height;
        const imageRatio = naturalWidth / naturalHeight;
        
        let displayWidth, displayHeight, offsetX, offsetY;
        
        if (containerRatio > imageRatio) {
            displayHeight = rect.height;
            displayWidth = rect.height * imageRatio;
            offsetX = (rect.width - displayWidth) / 2;
            offsetY = 0;
        } else {
            displayWidth = rect.width;
            displayHeight = rect.width / imageRatio;
            offsetX = 0;
            offsetY = (rect.height - displayHeight) / 2;
        }
        
        return {
            rect,
            naturalWidth,
            naturalHeight,
            displayWidth,
            displayHeight,
            offsetX,
            offsetY
        };
    }
    
    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
    map.addEventListener('click', function(e) {
        if (resultPanel.style.display === 'block') return;
        
        const dim = getMapDimensions();
        const clickX = e.clientX - dim.rect.left - dim.offsetX;
        const clickY = e.clientY - dim.rect.top - dim.offsetY;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (clickX < 0 || clickY < 0 || 
            clickX > dim.displayWidth || clickY > dim.displayHeight) {
            return;
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (0-26)
        const x = (clickX / dim.displayWidth * 26).toFixed(3);
        const y = (clickY / dim.displayHeight * 26).toFixed(3);
        
        // –ü–æ–∑–∏—Ü–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const markerX = clickX + dim.offsetX;
        const markerY = clickY + dim.offsetY;
        
        userMarker.style.left = markerX + 'px';
        userMarker.style.top = markerY + 'px';
        userMarker.style.display = 'block';
        
        latInput.value = x;
        lonInput.value = y;
        submitBtn.disabled = false;
    });
    
    // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    {% if show_results %}
    function showResults() {
        const dim = getMapDimensions();
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        const userX = ({{ user_guess_x }} / 26) * dim.displayWidth + dim.offsetX;
        const userY = ({{ user_guess_y }} / 26) * dim.displayHeight + dim.offsetY;
        const correctX = ({{ correct_x }} / 26) * dim.displayWidth + dim.offsetX;
        const correctY = ({{ correct_y }} / 26) * dim.displayHeight + dim.offsetY;
        
        userMarker.style.left = userX + 'px';
        userMarker.style.top = userY + 'px';
        userMarker.style.display = 'block';
        
        correctMarker.style.left = correctX + 'px';
        correctMarker.style.top = correctY + 'px';
        correctMarker.style.display = 'block';
        
        line.innerHTML = `
            <line x1="${userX}" y1="${userY}" 
                  x2="${correctX}" y2="${correctY}" 
                  stroke="blue" stroke-width="2" stroke-dasharray="5,5"/>
        `;
        line.style.display = 'block';
        
        resultPanel.style.display = 'block';
        submitBtn.style.display = 'none';
    }
    
    if (map.complete) {
        showResults();
    } else {
        map.addEventListener('load', showResults);
    }
    {% endif %}
    
    // –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞"
    newGameBtn.addEventListener('click', function() {
        window.location.href = "{{ url_for('game') }}";
    });
});
</script>
{% endblock %}